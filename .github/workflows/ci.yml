name: CI

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  actions: read
  contents: read

jobs:
  main:
    runs-on: ubuntu-latest

    steps:
      # Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Setup Node.js
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # Install Node dependencies
      - name: Install Node dependencies
        run: npm ci

      # Setup Java 17 (kept, but Java build is excluded)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # Install Maven (kept, but not used by Nx now)
      - name: Install Maven
        run: |
          sudo apt-get update
          sudo apt-get install -y maven

      # Verify Java & Maven (optional, can remove later)
      - name: Verify Java & Maven
        run: |
          java -version
          mvn -version
          which mvn

      # ✅ Nx build (JAVA APP EXCLUDED)
      - name: Run Nx build (exclude java-app)
        run: npx nx run-many -t build --parallel=3 --exclude=java-app

      # ✅ Nx lint/test/typecheck (JAVA APP EXCLUDED)
      - name: Run lint, test, typecheck (exclude java-app)
        run: npx nx run-many -t lint test typecheck --exclude=java-app
        if: always()
